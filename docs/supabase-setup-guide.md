# Supabase 數據庫設置指南

本文檔說明如何在 Supabase 中設置所需的表格和關係，以便錡利科技管理系統正常運作。

## 準備工作

1. 在 [Supabase](https://supabase.com/) 創建一個新專案
2. 獲取專案 URL 和匿名密鑰
3. 填入 `.env.local` 文件中

## 表格結構

以下是需要創建的表格及其欄位：

### 用戶表 (profiles)

Supabase 會自動創建 auth.users 表來存儲基本認證信息，但我們需要添加一個額外的用戶檔案表來存儲更多用戶相關信息。

```sql
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  name TEXT,
  avatar_url TEXT,
  role TEXT DEFAULT 'user' NOT NULL CHECK (role IN ('admin', 'manager', 'user')),
  department TEXT,
  phone TEXT,
  employee_id TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 為 profiles 表創建索引以提高查詢性能
CREATE INDEX profiles_id_idx ON public.profiles(id);
```

### 經銷商表 (distributors)

```sql
CREATE TABLE public.distributors (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  phone TEXT,
  fax TEXT,
  tax_id TEXT,
  address TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 物料商表 (suppliers)

```sql
CREATE TABLE public.suppliers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  phone TEXT,
  fax TEXT,
  tax_id TEXT,
  address TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 成品表 (products)

```sql
CREATE TABLE public.products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  image_url TEXT,
  category TEXT NOT NULL,
  efficiency TEXT NOT NULL,
  name TEXT NOT NULL,
  stock INTEGER NOT NULL DEFAULT 0,
  safety_stock INTEGER NOT NULL DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 物料表 (materials)

```sql
CREATE TABLE public.materials (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  image_url TEXT,
  category TEXT NOT NULL,
  efficiency TEXT NOT NULL,
  name TEXT NOT NULL,
  stock INTEGER NOT NULL DEFAULT 0,
  safety_stock INTEGER NOT NULL DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 訂購單表 (orders)

```sql
CREATE TABLE public.orders (
  id TEXT PRIMARY KEY,
  distributor_id BIGINT NOT NULL REFERENCES public.distributors(id),
  distributor_name TEXT NOT NULL,
  customer_po TEXT,
  order_date DATE NOT NULL,
  delivery_date DATE,
  total_amount NUMERIC(12, 2) NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT '待處理',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  delivery_method TEXT,
  shipping_company TEXT,
  shipping_address TEXT,
  contact_person TEXT,
  contact_phone TEXT,
  logistics_company TEXT
);
```

### 訂購單項目表 (order_items)

```sql
CREATE TABLE public.order_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  order_id TEXT NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  product_id BIGINT NOT NULL REFERENCES public.products(id),
  product_name TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  price NUMERIC(10, 2) NOT NULL,
  total NUMERIC(12, 2) NOT NULL,
  status TEXT NOT NULL DEFAULT '待處理'
);
```

### 採購單表 (purchases)

```sql
CREATE TABLE public.purchases (
  id TEXT PRIMARY KEY,
  supplier_id BIGINT NOT NULL REFERENCES public.suppliers(id),
  supplier_name TEXT NOT NULL,
  purchaser TEXT NOT NULL,
  purchase_date DATE NOT NULL,
  expected_delivery_date DATE,
  total_amount NUMERIC(12, 2) DEFAULT 0,
  status TEXT NOT NULL DEFAULT '草稿',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 採購單項目表 (purchase_items)

```sql
CREATE TABLE public.purchase_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  purchase_id TEXT NOT NULL REFERENCES public.purchases(id) ON DELETE CASCADE,
  material_id BIGINT NOT NULL REFERENCES public.materials(id),
  material_name TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  price NUMERIC(10, 2) DEFAULT 0,
  total NUMERIC(12, 2) DEFAULT 0,
  status TEXT DEFAULT '待處理'
);
```

## 設置 RLS（行級安全）政策

為了確保數據安全，建議針對每個表格設置適當的行級安全政策。以下是建議的基本政策：

### 特定用戶表的 RLS 政策

為 `profiles` 表設置 RLS 政策，讓用戶只能查看和修改自己的資料：

```sql
-- 啟用 RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- 允許用戶讀取自己的資料
CREATE POLICY "用戶可以查看自己的資料" ON public.profiles 
FOR SELECT USING (auth.uid() = id);

-- 允許用戶更新自己的資料
CREATE POLICY "用戶可以更新自己的資料" ON public.profiles 
FOR UPDATE USING (auth.uid() = id);

-- 允許新用戶創建個人資料
CREATE POLICY "新用戶可以創建個人資料" ON public.profiles 
FOR INSERT WITH CHECK (auth.uid() = id);

-- 管理員可以查看所有用戶資料（可選）
CREATE POLICY "管理員可以查看所有用戶資料" ON public.profiles 
FOR SELECT USING (
  EXISTS (
    SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'
  )
);
```

### 其他表格的 RLS 政策

對於其他表格執行以下操作：

1. 啟用 RLS：
```sql
ALTER TABLE public.table_name ENABLE ROW LEVEL SECURITY;
```

2. 創建允許已驗證用戶讀取的政策：
```sql
CREATE POLICY "允許已驗證用戶讀取" ON public.table_name 
FOR SELECT TO authenticated USING (true);
```

3. 創建允許已驗證用戶插入的政策：
```sql
CREATE POLICY "允許已驗證用戶插入" ON public.table_name 
FOR INSERT TO authenticated WITH CHECK (true);
```

4. 創建允許已驗證用戶更新的政策：
```sql
CREATE POLICY "允許已驗證用戶更新" ON public.table_name 
FOR UPDATE TO authenticated USING (true);
```

5. 創建允許已驗證用戶刪除的政策：
```sql
CREATE POLICY "允許已驗證用戶刪除" ON public.table_name 
FOR DELETE TO authenticated USING (true);
```

## 存儲桶設置

為了保存產品和物料圖片以及用戶頭像，需要設置存儲桶：

1. 在 Supabase Dashboard 中，導航到 "Storage" 頁面
2. 創建以下存儲桶：
   - `product-images`：用於存儲成品圖片
   - `material-images`：用於存儲物料圖片
   - `avatars`：用於存儲用戶頭像
3. 為每個存儲桶設置適當的安全策略：

### 頭像存儲桶 RLS 策略

```sql
-- 允許已驗證用戶上傳自己的頭像
CREATE POLICY "允許已驗證用戶上傳頭像" ON storage.objects
FOR INSERT TO authenticated WITH CHECK (
  bucket_id = 'avatars' AND 
  (storage.foldername(name))[1] = auth.uid()::text
);

-- 允許已驗證用戶更新自己的頭像
CREATE POLICY "允許已驗證用戶更新頭像" ON storage.objects
FOR UPDATE TO authenticated USING (
  bucket_id = 'avatars' AND 
  (storage.foldername(name))[1] = auth.uid()::text
);

-- 允許公開讀取頭像
CREATE POLICY "允許公開讀取頭像" ON storage.objects
FOR SELECT USING (bucket_id = 'avatars');
```

## 用戶註冊與邀請設置

對於管理系統，通常需要限制用戶註冊，以下是一些建議設置：

1. 在 Supabase Dashboard 中，導航到 "Authentication" > "Providers"
2. 禁用公開註冊，僅允許通過邀請鏈接註冊
3. 配置郵件模板，使其符合公司品牌風格

## 資料庫更新說明

若您的系統已經部署並運行中，需要更新資料庫結構，請執行以下 SQL 語句：

### 2023-08-01 新增訂購單物流相關欄位

```sql
-- 添加運送相關欄位
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS delivery_method TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS shipping_company TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS shipping_address TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS contact_person TEXT;
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS contact_phone TEXT;
```

### 2023-09-15 新增物流公司名稱欄位

```sql
-- 添加物流公司名稱欄位
ALTER TABLE public.orders ADD COLUMN IF NOT EXISTS logistics_company TEXT;
```

### 2024-05-07 新增用戶配置表

如果系統之前沒有用戶個人資料表，請執行上方的 profiles 表創建語句。如果已經有用戶使用系統，請執行以下遷移語句：

```sql
-- 為現有用戶創建個人資料記錄
INSERT INTO public.profiles (id, name)
SELECT id, email FROM auth.users
WHERE NOT EXISTS (SELECT 1 FROM public.profiles WHERE profiles.id = users.id);
```

## 用戶資料處理說明

當用戶更新其個人資料時，系統會執行以下操作：

1. 通過 Supabase Auth API 更新用戶的元數據 (`user_metadata`)
2. 同時更新 `profiles` 表中對應的記錄

請確保在用戶註冊成功後立即創建其 `profiles` 表記錄，以便於後續的資料管理。

## 測試連接

完成以上設置後，您應該能夠在應用中訪問數據庫和用戶資料。您可以在控制台中運行以下命令測試連接：

```typescript
import { supabase } from '@/lib/supabase'

async function testConnection() {
  // 測試讀取經銷商資料
  const { data: distributors, error: distributorsError } = await supabase
    .from('distributors')
    .select('*')
    .limit(1)
  
  if (distributorsError) {
    console.error('經銷商資料連接失敗:', distributorsError)
  } else {
    console.log('經銷商資料連接成功:', distributors)
  }
  
  // 測試獲取當前用戶
  const { data: userData, error: userError } = await supabase.auth.getUser()
  
  if (userError) {
    console.error('用戶資料獲取失敗:', userError)
  } else if (userData.user) {
    console.log('用戶資料獲取成功:', userData.user)
    
    // 測試獲取用戶個人資料
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userData.user.id)
      .single()
    
    if (profileError) {
      console.error('用戶個人資料獲取失敗:', profileError)
    } else {
      console.log('用戶個人資料獲取成功:', profile)
    }
  }
}

testConnection()
``` 