# Supabase 數據庫設置指南

本文檔說明如何在 Supabase 中設置所需的表格和關係，以便錡利科技管理系統正常運作。

## 準備工作

1. 在 [Supabase](https://supabase.com/) 創建一個新專案
2. 獲取專案 URL 和匿名密鑰
3. 填入 `.env.local` 文件中

## 表格結構

以下是需要創建的表格及其欄位：

### 經銷商表 (distributors)

```sql
CREATE TABLE public.distributors (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  phone TEXT,
  fax TEXT,
  tax_id TEXT,
  address TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 物料商表 (suppliers)

```sql
CREATE TABLE public.suppliers (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  phone TEXT,
  fax TEXT,
  tax_id TEXT,
  address TEXT,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 成品表 (products)

```sql
CREATE TABLE public.products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  image_url TEXT,
  category TEXT NOT NULL,
  efficiency TEXT NOT NULL,
  name TEXT NOT NULL,
  stock INTEGER NOT NULL DEFAULT 0,
  safety_stock INTEGER NOT NULL DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 物料表 (materials)

```sql
CREATE TABLE public.materials (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  image_url TEXT,
  category TEXT NOT NULL,
  efficiency TEXT NOT NULL,
  name TEXT NOT NULL,
  stock INTEGER NOT NULL DEFAULT 0,
  safety_stock INTEGER NOT NULL DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 訂購單表 (orders)

```sql
CREATE TABLE public.orders (
  id TEXT PRIMARY KEY,
  distributor_id BIGINT NOT NULL REFERENCES public.distributors(id),
  distributor_name TEXT NOT NULL,
  customer_po TEXT,
  order_date DATE NOT NULL,
  delivery_date DATE,
  total_amount NUMERIC(12, 2) NOT NULL DEFAULT 0,
  status TEXT NOT NULL DEFAULT '待處理',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 訂購單項目表 (order_items)

```sql
CREATE TABLE public.order_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  order_id TEXT NOT NULL REFERENCES public.orders(id) ON DELETE CASCADE,
  product_id BIGINT NOT NULL REFERENCES public.products(id),
  product_name TEXT NOT NULL,
  quantity INTEGER NOT NULL,
  price NUMERIC(10, 2) NOT NULL,
  total NUMERIC(12, 2) NOT NULL,
  status TEXT NOT NULL DEFAULT '待處理'
);
```

### 採購單表 (purchases)

```sql
CREATE TABLE public.purchases (
  id TEXT PRIMARY KEY,
  supplier_id BIGINT NOT NULL REFERENCES public.suppliers(id),
  supplier_name TEXT NOT NULL,
  purchaser TEXT NOT NULL,
  purchase_date DATE NOT NULL,
  status TEXT NOT NULL DEFAULT '草稿',
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 採購單項目表 (purchase_items)

```sql
CREATE TABLE public.purchase_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  purchase_id TEXT NOT NULL REFERENCES public.purchases(id) ON DELETE CASCADE,
  material_id BIGINT NOT NULL REFERENCES public.materials(id),
  material_name TEXT NOT NULL,
  quantity INTEGER NOT NULL
);
```

## 設置 RLS（行級安全）政策

為了確保數據安全，建議針對每個表格設置適當的行級安全政策。以下是建議的基本政策：

### 啟用 RLS 並設置讀取政策

對於每個表格執行以下操作：

1. 啟用 RLS：
```sql
ALTER TABLE public.table_name ENABLE ROW LEVEL SECURITY;
```

2. 創建允許已驗證用戶讀取的政策：
```sql
CREATE POLICY "允許已驗證用戶讀取" ON public.table_name 
FOR SELECT TO authenticated USING (true);
```

3. 創建允許已驗證用戶插入的政策：
```sql
CREATE POLICY "允許已驗證用戶插入" ON public.table_name 
FOR INSERT TO authenticated WITH CHECK (true);
```

4. 創建允許已驗證用戶更新的政策：
```sql
CREATE POLICY "允許已驗證用戶更新" ON public.table_name 
FOR UPDATE TO authenticated USING (true);
```

5. 創建允許已驗證用戶刪除的政策：
```sql
CREATE POLICY "允許已驗證用戶刪除" ON public.table_name 
FOR DELETE TO authenticated USING (true);
```

## 存儲桶設置

為了保存產品和物料圖片，需要設置存儲桶：

1. 在 Supabase Dashboard 中，導航到 "Storage" 頁面
2. 創建兩個新的存儲桶：
   - `product-images`：用於存儲成品圖片
   - `material-images`：用於存儲物料圖片
3. 為每個存儲桶設置公共訪問策略或適當的安全策略

## 測試連接

完成以上設置後，您應該能夠在應用中訪問數據庫。您可以在控制台中運行以下命令測試連接：

```typescript
import { supabase } from '@/lib/supabase'

async function testConnection() {
  const { data, error } = await supabase.from('distributors').select('*').limit(1)
  if (error) {
    console.error('連接失敗:', error)
  } else {
    console.log('連接成功:', data)
  }
}

testConnection()
``` 